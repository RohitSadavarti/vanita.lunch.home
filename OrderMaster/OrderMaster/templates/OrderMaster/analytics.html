{% extends 'OrderMaster/base.html' %}
{% load static %}

{% block title %}Analytics{% endblock %}

{% block content %}
<!-- This script for datalabels is added here to avoid editing base.html -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<style>
    /* Your preferred new styles are used here */
    :root {
        --primary: #1e40af;
        --secondary: #059669;
        --muted: #f3f4f6;
        --text: #0b0f19;
        --text-muted: #374151;
        --card-bg: #ffffff;
        --border: #e5e7eb;
    }
    .main-content { background: var(--muted); }
    .container-fluid { max-width:1280px; }

    /* Layout & Cards */
    .grid-layout { display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:992px){ .grid-layout { grid-template-columns: 2fr 1fr; } }
    
    .left-col, .right-col { display:flex; flex-direction:column; gap:16px; }
    .card { background:var(--card-bg); border:1px solid var(--border); border-radius:10px; padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-header { padding: 0 0 12px 0; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
    .card-title { font-size: 16px; font-weight: 600; margin:0; }
    .card-body { padding: 0; }
    
    /* Filters */
    .filters { display:flex; flex-wrap:wrap; gap:12px; align-items:center; background:var(--card-bg); border:1px solid var(--border); padding:12px; border-radius:8px; margin-bottom: 16px; }
    .filters .group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .filters label { font-size:14px; color:var(--text-muted); }
    .filters input[type="date"] { padding:6px 8px; border:1px solid var(--border); border-radius:6px; background:#fff; }
    .btn-sm { background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; }

    /* KPIs */
    .kpis { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .kpi { background:#fff; border:1px solid var(--border); border-radius:10px; padding:12px; }
    .kpi h3 { margin:0 0 6px 0; font-size:13px; color:var(--text-muted); font-weight: 500; }
    .kpi .val { font-size:22px; font-weight:700; }

    /* Chart Containers */
    .chart-container { position: relative; height: 280px; }
</style>

<div class="container-fluid">
    <header class="d-sm-flex align-items-center justify-content-between my-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Analytics Dashboard</h1>
            <p class="text-muted mb-0">An overview of your restaurant's performance</p>
        </div>
    </header>

    <!-- Filters Section -->
    <section class="filters" aria-label="Filters">
        <div class="group" role="group">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dateFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Select Date Range
                </button>
                <ul class="dropdown-menu" aria-labelledby="dateFilterDropdown">
                    <li><a class="dropdown-item date-filter" href="#" data-filter="today">Today</a></li>
                    <li><a class="dropdown-item date-filter" href="#" data-filter="this_week">This Week</a></li>
                    <li><a class="dropdown-item date-filter" href="#" data-filter="this_month">This Month</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="customDateBtn">Custom Range</a></li>
                </ul>
            </div>
            <div id="customDateRange" class="group d-none">
                <form id="customDateForm" class="d-flex align-items-center">
                    <input type="date" class="form-control form-control-sm" name="start_date">
                    <input type="date" class="form-control form-control-sm ms-2" name="end_date">
                    <button type="submit" class="btn btn-sm btn-primary ms-2">Apply</button>
                </form>
            </div>
        </div>
        <div class="group" role="group" id="paymentFilter">
            <input type="radio" class="btn-check" name="payment-filter" id="total" value="Total" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="total">Total</label>
            
            <input type="radio" class="btn-check" name="payment-filter" id="cash" value="Cash" autocomplete="off">
            <label class="btn btn-outline-primary" for="cash">Cash</label>
            
            <input type="radio" class="btn-check" name="payment-filter" id="online" value="Online" autocomplete="off">
            <label class="btn btn-outline-primary" for="online">Online</label>
        </div>
    </section>
    
    <!-- Main Grid Layout -->
    <div class="grid-layout">
        <!-- Left Column -->
        <section class="left-col">
            <!-- KPIs -->
            <div class="kpis">
                <div class="kpi">
                    <h3>Total Revenue</h3>
                    <div class="val" id="totalRevenue">₹0.00</div>
                </div>
                <div class="kpi">
                    <h3>Total Orders</h3>
                    <div class="val" id="totalOrders">0</div>
                </div>
                <div class="kpi">
                    <h3>Avg. Order Value</h3>
                    <div class="val" id="avgOrderValue">₹0.00</div>
                </div>
            </div>
            <!-- Most Ordered Items Chart -->
            <div class="card">
                <div class="card-header"><h4 class="card-title">Most Ordered Items</h4></div>
                <div class="card-body"><div class="chart-container"><canvas id="mostOrderedItemsChart"></canvas></div></div>
            </div>
             <!-- Day-wise Revenue Chart -->
            <div class="card">
                <div class="card-header"><h4 class="card-title">Day-wise Revenue & Orders</h4></div>
                <div class="card-body"><div class="chart-container"><canvas id="dayWiseRevenueChart"></canvas></div></div>
            </div>
        </section>

        <!-- Right Column -->
        <section class="right-col">
             <!-- Payment Method Donut Chart -->
             <div class="card">
                <div class="card-header"><h4 class="card-title">Revenue by Payment Method</h4></div>
                <div class="card-body"><div class="chart-container"><canvas id="paymentMethodChart"></canvas></div></div>
            </div>
             <!-- Orders by Hour Chart -->
             <div class="card">
                <div class="card-header"><h4 class="card-title">Orders by Hour</h4></div>
                <div class="card-body"><div class="chart-container"><canvas id="ordersByHourChart"></canvas></div></div>
            </div>
        </section>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Register the datalabels plugin globally
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', {
        color: '#fff',
        font: { weight: 'bold' },
        formatter: (value) => {
            if (value === 0) return '';
            // For numbers > 1000, show as '1.2k' etc.
            if (value > 1000) return (value/1000).toFixed(1) + 'k';
            return value;
        }
    });

    let mostOrderedItemsChart, paymentMethodChart, ordersByHourChart, dayWiseRevenueChart;

    // Main function to fetch and render all data
    async function fetchAnalyticsData() {
        const dateFilterElement = document.querySelector('.date-filter.active');
        let dateFilter = 'this_month';
        if (dateFilterElement) {
            dateFilter = dateFilterElement.dataset.filter;
        } else if (document.getElementById('dateFilterDropdown').textContent === 'Custom') {
            dateFilter = 'custom';
        }
        
        const paymentFilter = document.querySelector('#paymentFilter input:checked').value;
        let url = `/api/analytics/?date_filter=${dateFilter}&payment_filter=${paymentFilter}`;

        if (dateFilter === 'custom') {
            const startDate = document.querySelector('input[name="start_date"]').value;
            const endDate = document.querySelector('input[name="end_date"]').value;
            if (startDate && endDate) {
                url += `&start_date=${startDate}&end_date=${endDate}`;
            }
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            // Update UI elements
            document.getElementById('totalRevenue').textContent = '₹' + data.key_metrics.total_revenue;
            document.getElementById('totalOrders').textContent = data.key_metrics.total_orders;
            document.getElementById('avgOrderValue').textContent = '₹' + data.key_metrics.average_order_value;
            
            // Update all charts
            updateMostOrderedChart(data.most_ordered_items);
            updatePaymentMethodChart(data.payment_method_distribution);
            updateOrdersByHourChart(data.orders_by_hour);
            updateDayWiseRevenueChart(data.day_wise_revenue);

        } catch (error) {
            console.error('Failed to fetch analytics data:', error);
        }
    }

    // --- Chart Update Functions ---

    function updateMostOrderedChart({ labels, data }) {
        const ctx = document.getElementById('mostOrderedItemsChart').getContext('2d');
        if (mostOrderedItemsChart) mostOrderedItemsChart.destroy();
        mostOrderedItemsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Quantity Sold',
                    data: data,
                    backgroundColor: 'rgba(30, 64, 175, 0.8)',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        color: '#fff'
                    }
                }
            }
        });
    }

    function updatePaymentMethodChart({ labels, data }) {
        const ctx = document.getElementById('paymentMethodChart').getContext('2d');
        if (paymentMethodChart) paymentMethodChart.destroy();
        paymentMethodChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue',
                    data: data,
                    backgroundColor: ['#1e40af', '#059669', '#374151', '#f3f4f6'],
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (value*100 / sum).toFixed(1) + "%";
                            if (sum === 0 || value === 0) return '';
                            return percentage;
                        },
                         color: '#fff',
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => ` ${context.label}: ${new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed)}`
                        }
                    }
                }
            }
        });
    }

    function updateOrdersByHourChart({ labels, data }) {
        const ctx = document.getElementById('ordersByHourChart').getContext('2d');
        if (ordersByHourChart) ordersByHourChart.destroy();
        ordersByHourChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Orders',
                    data: data,
                    borderColor: '#059669',
                    backgroundColor: 'rgba(5, 150, 105, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, suggestedMax: Math.max(...data) + 2 } },
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        align: 'top',
                        color: '#374151'
                    }
                }
            }
        });
    }

    function updateDayWiseRevenueChart({ labels, revenue_data, orders_data }) {
        const ctx = document.getElementById('dayWiseRevenueChart').getContext('2d');
        if (dayWiseRevenueChart) dayWiseRevenueChart.destroy();
        dayWiseRevenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue (₹)',
                        data: revenue_data,
                        backgroundColor: 'rgba(30, 64, 175, 0.8)',
                        yAxisID: 'yRevenue',
                    },
                    {
                        label: 'Orders',
                        data: orders_data,
                        backgroundColor: 'rgba(5, 150, 105, 0.6)',
                        yAxisID: 'yOrders',
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    yRevenue: {
                        type: 'linear', display: true, position: 'left',
                        beginAtZero: true, title: { display: true, text: 'Revenue (₹)' }
                    },
                    yOrders: {
                        type: 'linear', display: true, position: 'right',
                        beginAtZero: true, title: { display: true, text: 'Number of Orders' },
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    datalabels: {
                         color: 'white',
                         font: { size: 10 }
                    },
                    legend: { position: 'top' }
                }
            }
        });
    }

    // --- Event Listeners ---
    document.querySelectorAll('.date-filter').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.date-filter').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('dateFilterDropdown').textContent = this.textContent;
            document.getElementById('customDateRange').classList.add('d-none');
            fetchAnalyticsData();
        });
    });

    document.getElementById('customDateBtn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('customDateRange').classList.remove('d-none');
    });

    document.getElementById('customDateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.querySelectorAll('.date-filter').forEach(l => l.classList.remove('active'));
        document.getElementById('dateFilterDropdown').textContent = 'Custom';
        fetchAnalyticsData();
    });

    document.querySelectorAll('#paymentFilter input').forEach(radio => {
        radio.addEventListener('change', fetchAnalyticsData);
    });

    // --- Initial Load ---
    const defaultDateFilter = document.querySelector('.date-filter[data-filter="this_month"]');
    if (defaultDateFilter) {
        defaultDateFilter.classList.add('active');
        document.getElementById('dateFilterDropdown').textContent = 'This Month';
    }
    fetchAnalyticsData();
});
</script>
{% endblock %}

