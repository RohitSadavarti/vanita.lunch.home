{% extends 'OrderMaster/base.html' %}
{% load static %}
 
{% block content %}
<style>
    .kpi-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .kpi-card h5 {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .kpi-card p {
        font-size: 2rem;
        font-weight: 700;
        color: #343a40;
    }
    .chart-container {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        /* --- AMENDMENT: Set a fixed height for chart containers --- */
        position: relative;
        height: 450px; 
    }
</style>
 
<main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h3>Analytics Dashboard</h3>
        <form id="dateFilterForm" class="d-flex align-items-center gap-2">
            <div class="dropdown">    
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dateFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Showing: <span id="date-display" class="fw-bold">This Month</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dateFilterDropdown">
                    <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_week">This Week</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_month">This Month</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="customDateBtn">Custom Range...</a></li>
                </ul>
            </div>
            <div id="customDateRange" class="d-none align-items-center gap-2">
                <input type="date" class="form-control form-control-sm" name="start_date" id="startDate" placeholder="Start Date">
                <input type="date" class="form-control form-control-sm" name="end_date" id="endDate" placeholder="End Date">
                <button class="btn btn-primary btn-sm" type="button" id="applyCustomDate">Apply</button>
            </div>
        </form>
    </div>
 
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Total Revenue</h5>
                <p id="total-revenue">₹0.00</p>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Total Orders</h5>
                <p id="total-orders">0</p>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Average Order Value</h5>
                <p id="avg-order-value">₹0.00</p>
            </div>
        </div>
    </div>
 
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <h5>Top 5 Products by Order Type</h5>
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <h5>Most Ordered Items</h5>
                <canvas id="mostOrderedItemsChart"></canvas>
            </div>
        </div>
    </div>
</main>
 
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dateDisplay = document.getElementById('date-display');
    const customDateBtn = document.getElementById('customDateBtn');
    const customDateRangeDiv = document.getElementById('customDateRange');
    
    let topProductsChart, mostOrderedItemsChart;
 
    const renderCharts = (data) => {
        // --- Key Metrics ---
        document.getElementById('total-revenue').textContent = `₹${data.key_metrics.total_revenue}`;
        document.getElementById('total-orders').textContent = data.key_metrics.total_orders;
        document.getElementById('avg-order-value').textContent = `₹${data.key_metrics.average_order_value}`;
 
        // --- Top Products Chart (100% Stacked Bar) ---
        const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
        if (topProductsChart) topProductsChart.destroy();
        topProductsChart = new Chart(topProductsCtx, {
            type: 'bar',
            data: {
                labels: data.top_products_by_type.labels,
                datasets: data.top_products_by_type.datasets,
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // To make it horizontal
                plugins: {
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    },
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            callback: function(value, index, values) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Percentage of Orders'
                        }
                    },
                    y: {
                        stacked: true
                    }
                }
            }
        });
 
        // --- Most Ordered Items Chart (Doughnut) ---
        const itemsCtx = document.getElementById('mostOrderedItemsChart').getContext('2d');
        if (mostOrderedItemsChart) mostOrderedItemsChart.destroy();
        mostOrderedItemsChart = new Chart(itemsCtx, {
            type: 'doughnut',
            data: {
                labels: data.most_ordered_items.labels,
                datasets: [{
                    label: 'Quantity Sold',
                    data: data.most_ordered_items.data,
                    backgroundColor: [
                        '#ff8100', '#ff9f40', '#ffbd6e', '#ffda9a', '#ffedc9'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    };
 
    const fetchAnalyticsData = async (filter = 'this_month', startDate = '', endDate = '') => {
        let url = `/api/analytics/?date_filter=${filter}`;
        if (filter === 'custom' && startDate && endDate) {
            url += `&start_date=${startDate}&end_date=${endDate}`;
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            renderCharts(data);
        } catch (error) {
            console.error('Failed to fetch analytics data:', error);
        }
    };
 
    // Event Listeners for Filters
    document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const filter = this.dataset.filter;
            dateDisplay.textContent = this.textContent;
            customDateRangeDiv.classList.add('d-none');
            fetchAnalyticsData(filter);
        });
    });
 
    customDateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        customDateRangeDiv.classList.toggle('d-none');
    });
 
    document.getElementById('applyCustomDate').addEventListener('click', function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            dateDisplay.textContent = `${start.toLocaleDateString('en-GB', options)} - ${end.toLocaleDateString('en-GB', options)}`;
            fetchAnalyticsData('custom', startDate, endDate);
        }
    });
 
    // Initial load
    fetchAnalyticsData();
});
</script>
{% endblock %}
