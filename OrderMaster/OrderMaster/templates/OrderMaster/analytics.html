{% extends 'OrderMaster/base.html' %}
{% load static %}

{% block content %}
<style>
    .kpi-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .kpi-card h5 {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .kpi-card p {
        font-size: 2rem;
        font-weight: 700;
        color: #343a40;
    }
    .chart-container {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
</style>

<main class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h3>Analytics Dashboard</h3>
        <form id="dateFilterForm" class="d-flex align-items-center gap-2">
            <div class="dropdown">    
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dateFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Showing: <span id="date-display" class="fw-bold">This Month</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dateFilterDropdown">
                    <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_week">This Week</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_month">This Month</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="customDateBtn">Custom Range...</a></li>
                </ul>
            </div>
            <div id="customDateRange" class="d-none align-items-center gap-2">
                <input type="date" class="form-control form-control-sm" name="start_date" id="startDate" placeholder="Start Date">
                <input type="date" class="form-control form-control-sm" name="end_date" id="endDate" placeholder="End Date">
                <button class="btn btn-primary btn-sm" type="button" id="applyCustomDate">Apply</button>
            </div>
        </form>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h3>Analytics Dashboard</h3>
        <form id="dateFilterForm" class="d-flex align-items-center gap-2">
            <div class="dropdown">    
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dateFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Showing: <span id="date-display" class="fw-bold">This Month</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dateFilterDropdown">
                    <li><a class="dropdown-item" href="#" data-filter="today">Today</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_week">This Week</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="this_month">This Month</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="customDateBtn">Custom Range...</a></li>
                </ul>
            </div>
            <div id="customDateRange" class="d-none align-items-center gap-2">
                <input type="date" class="form-control form-control-sm" name="start_date" id="startDate" placeholder="Start Date">
                <input type="date" class="form-control form-control-sm" name="end_date" id="endDate" placeholder="End Date">
                <button class="btn btn-primary btn-sm" type="button" id="applyCustomDate">Apply</button>
            </div>
        </form>
    </div>

    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Total Revenue</h5>
                <p id="total-revenue">₹0.00</p>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Total Orders</h5>
                <p id="total-orders">0</p>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="kpi-card">
                <h5>Average Order Value</h5>
                <p id="avg-order-value">₹0.00</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <h5>Day-Wise Income</h5>
                <canvas id="dailyIncomeChart"></canvas>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <h5>Most Ordered Items</h5>
                <canvas id="mostOrderedItemsChart"></canvas>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dateDisplay = document.getElementById('date-display');
    const customDateBtn = document.getElementById('customDateBtn');
    const customDateRangeDiv = document.getElementById('customDateRange');
    
    let dailyIncomeChart, mostOrderedItemsChart;

    const renderCharts = (data) => {
        // --- Key Metrics ---
        document.getElementById('total-revenue').textContent = `₹${data.key_metrics.total_revenue}`;
        document.getElementById('total-orders').textContent = data.key_metrics.total_orders;
        document.getElementById('avg-order-value').textContent = `₹${data.key_metrics.average_order_value}`;

        // --- Daily Income Chart (Line) ---
        const dailyCtx = document.getElementById('dailyIncomeChart').getContext('2d');
        if (dailyIncomeChart) dailyIncomeChart.destroy();
        dailyIncomeChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: data.daily_income.labels,
                datasets: [{
                    label: 'Income',
                    data: data.daily_income.data,
                    borderColor: '#ff8100',
                    backgroundColor: 'rgba(255, 129, 0, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // --- Most Ordered Items Chart (Pie) ---
        const itemsCtx = document.getElementById('mostOrderedItemsChart').getContext('2d');
        if (mostOrderedItemsChart) mostOrderedItemsChart.destroy();
        mostOrderedItemsChart = new Chart(itemsCtx, {
            type: 'pie',
            data: {
                labels: data.most_ordered_items.labels,
                datasets: [{
                    label: 'Quantity Sold',
                    data: data.most_ordered_items.data,
                    backgroundColor: [
                        '#ff8100', 
                        '#ff9f40', 
                        '#ffbd6e', // AMENDMENT 2: Corrected typo from '#ffb-d6e'
                        '#ffda9a', 
                        '#ffedc9', 
                        '#fce2a9', 
                        '#f9d789'
                    ]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    const fetchAnalyticsData = async (filter = 'this_month', startDate = '', endDate = '') => {
        let url = `/api/analytics/?date_filter=${filter}`;
        if (filter === 'custom' && startDate && endDate) {
            url += `&start_date=${startDate}&end_date=${endDate}`;
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            renderCharts(data);
        } catch (error) {
            console.error('Failed to fetch analytics data:', error);
            // Optionally, display an error message to the user on the dashboard
        }
    };

    // --- Event Listeners for Filters ---
    document.querySelectorAll('.dropdown-item[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const filter = this.dataset.filter;
            dateDisplay.textContent = this.textContent;
            customDateRangeDiv.classList.add('d-none');
            fetchAnalyticsData(filter);
        });
    });

    customDateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        customDateRangeDiv.classList.toggle('d-none');
    });

    document.getElementById('applyCustomDate').addEventListener('click', function() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        if (startDate && endDate) {
            // AMENDMENT 3: Improved display for custom date range
            const start = new Date(startDate);
            const end = new Date(endDate);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            dateDisplay.textContent = `${start.toLocaleDateString('en-GB', options)} - ${end.toLocaleDateString('en-GB', options)}`;
            fetchAnalyticsData('custom', startDate, endDate);
        }
    });

    // Initial load
    fetchAnalyticsData();
});
</script>
{% endblock %}
