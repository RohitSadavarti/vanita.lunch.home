{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}VLH Dashboard{% endblock %}</title>
    <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="{% static 'css/sb-admin-2.min.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body id="page-top">
    <div id="wrapper">
        {% include 'OrderMaster/includes/sidebar.html' %}
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                {% include 'OrderMaster/includes/topbar.html' %}
                {% block content %}{% endblock %}
                </div>
            {% include 'OrderMaster/includes/footer.html' %}
            </div>
    </div>
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>
    
    {% include 'OrderMaster/includes/scripts.html' %}

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script>
        // IMPORTANT: You MUST get this config object from your Firebase project settings
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const messaging = firebase.messaging();

        function requestNotificationPermission() {
            console.log('Requesting notification permission...');
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    
                    // Get the token
                    messaging.getToken({ vapidKey: 'YOUR_FIREBASE_WEB_PUSH_CERTIFICATE_KEY' })
                        .then((currentToken) => {
                            if (currentToken) {
                                console.log('FCM Token:', currentToken);
                                // Here you would typically send this token to your server
                                // to subscribe it to the 'new_orders' topic.
                                // For simplicity, we'll rely on the service worker for now.
                                // A full implementation would require a backend endpoint
                                // in Django to handle the subscription.
                            } else {
                                console.log('No registration token available. Request permission to generate one.');
                            }
                        }).catch((err) => {
                            console.log('An error occurred while retrieving token. ', err);
                        });

                } else {
                    console.log('Unable to get permission to notify.');
                }
            });
        }
        
        // Listen for messages when the page is in the foreground
        messaging.onMessage((payload) => {
            console.log('Message received. ', payload);
            // Display a custom notification/toast
            const notificationTitle = payload.notification.title;
            const notificationBody = payload.notification.body;
            
            // Example using a simple alert, but a toast notification library would be better
            alert(`New Notification:\nTitle: ${notificationTitle}\nBody: ${notificationBody}`);
        });

        // Call the function to request permission when the page loads
        requestNotificationPermission();

    </script>
    </body>
</html>
