{% extends 'OrderMaster/base.html' %}
{% load static %}

{% block title %}Menu Management{% endblock %}

{% block content %}
<div class="modal fade" id="editMenuItemModal" tabindex="-1" aria-labelledby="editMenuItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMenuItemModalLabel">Edit Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMenuItemForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="edit-item-id" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-item_name" class="form-label">Item Name</label>
                            <input type="text" class="form-control" id="edit-item_name" name="item_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="edit-price" name="price" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-image_url" class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="edit-image_url" name="image_url" placeholder="[https://example.com/image.jpg](https://example.com/image.jpg)">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-category" class="form-label">Category</label>
                            <select class="form-select" id="edit-category" name="category" required>
                                <option value="" disabled selected>Select Category</option>
                                <option value="Main Course">Main Course</option>
                                <option value="Starters">Starters</option>
                                <option value="Beverages">Beverages</option>
                                <option value="Desserts">Desserts</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-veg_nonveg" class="form-label">Type</label>
                             <select class="form-select" id="edit-veg_nonveg" name="veg_nonveg" required>
                                <option value="" disabled selected>Select Type</option>
                                <option value="Veg">Veg</option>
                                <option value="Non-Veg">Non-Veg</option>
                                <option value="Contains Egg">Contains Egg</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-meal_type" class="form-label">Meal Type</label>
                             <select class="form-select" id="edit-meal_type" name="meal_type" required>
                                <option value="" disabled selected>Select Meal Type</option>
                                <option value="Breakfast">Breakfast</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Dinner">Dinner</option>
                                <option value="All Day">All Day</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-availability_time" class="form-label">Availability</label>
                            <input type="text" class="form-control" id="edit-availability_time" name="availability_time" placeholder="e.g., 12 PM - 10 PM">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const editModalEl = document.getElementById('editMenuItemModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const editForm = document.getElementById('editMenuItemForm'); // Reference the form itself

    // --- FIX: Updated Edit Button Handler ---
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const itemId = this.dataset.itemId;
            editForm.action = `/api/menu-item/${itemId}/`; // Set form action URL

            try {
                const response = await fetch(`/api/menu-item/${itemId}/`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch item details (Status: ${response.status})`);
                }

                const item = await response.json();
                console.log('Fetched item data:', item); // Debug log

                // Populate all form fields
                document.getElementById('edit-item-id').value = item.id || ''; // Hidden field
                document.getElementById('edit-item_name').value = item.item_name || '';
                document.getElementById('edit-price').value = item.price || '';
                document.getElementById('edit-description').value = item.description || '';
                document.getElementById('edit-image_url').value = item.image_url || '';
                document.getElementById('edit-availability_time').value = item.availability_time || '';

                // --- FIX: Correctly set dropdown values ---
                const categorySelect = document.getElementById('edit-category');
                const vegNonvegSelect = document.getElementById('edit-veg_nonveg');
                const mealTypeSelect = document.getElementById('edit-meal_type');

                // Set category (check if value exists in options)
                if (item.category && [...categorySelect.options].some(opt => opt.value === item.category)) {
                    categorySelect.value = item.category;
                    console.log('Set category to:', item.category);
                } else {
                    categorySelect.value = ""; // Default to placeholder if not found
                    console.warn(`Category '${item.category}' not found in dropdown options.`);
                }

                // Set veg/non-veg (check if value exists in options)
                if (item.veg_nonveg && [...vegNonvegSelect.options].some(opt => opt.value === item.veg_nonveg)) {
                    vegNonvegSelect.value = item.veg_nonveg;
                    console.log('Set veg_nonveg to:', item.veg_nonveg);
                } else {
                    vegNonvegSelect.value = ""; // Default to placeholder
                    console.warn(`Veg/Non-veg type '${item.veg_nonveg}' not found in dropdown options.`);
                }

                // Set meal type (check if value exists in options)
                if (item.meal_type && [...mealTypeSelect.options].some(opt => opt.value === item.meal_type)) {
                    mealTypeSelect.value = item.meal_type;
                    console.log('Set meal_type to:', item.meal_type);
                } else {
                    mealTypeSelect.value = ""; // Default to placeholder
                    console.warn(`Meal type '${item.meal_type}' not found in dropdown options.`);
                }
                // --- END FIX ---

                // Show the modal
                editModal.show();
            } catch (error) {
                console.error('Error fetching menu item details:', error);
                alert(`Could not load item details: ${error.message}. Please try again.`);
            }
        });
    });

    // --- FIX: Updated Form Submission Handler ---
    editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = editForm.querySelector('button[type="submit"]');
        submitButton.disabled = true; // Prevent double submit
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

        const formData = new FormData(this);
        const actionUrl = this.action; // Get URL from form action attribute

        fetch(actionUrl, {
            method: 'POST',
            // Use URLSearchParams for simple form data or keep FormData if you plan file uploads
            body: new URLSearchParams(formData),
            headers: {
                // 'Content-Type': 'application/x-www-form-urlencoded', // Needed for URLSearchParams
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data }))) // Parse JSON regardless of status
        .then(({ status, body }) => {
            if (status === 200 && body.success) { // Check for successful status code AND success flag
                editModal.hide();
                // Show success message briefly before reload
                alert('Item updated successfully!');
                setTimeout(() => {
                    window.location.reload();
                }, 300); // Shorter delay
            } else {
                // --- IMPROVED ERROR HANDLING ---
                let errorMsg = 'Error updating item. Please fix the following issues:\n\n';
                if (body.errors && typeof body.errors === 'object') {
                    for (const field in body.errors) {
                        if (body.errors.hasOwnProperty(field) && Array.isArray(body.errors[field])) {
                            // Convert field name like 'item_name' to 'Item name'
                            const fieldName = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            errorMsg += `• ${fieldName}: ${body.errors[field].join(', ')}\n`;
                        }
                    }
                } else if (body.error) { // Handle generic errors if 'errors' object isn't present
                     errorMsg = body.error;
                }
                 else {
                    errorMsg = 'An unknown error occurred. Check the console for details.';
                    console.error('Unexpected error response:', status, body);
                }
                alert(errorMsg); // Show detailed error
                console.error('Validation Errors:', body.errors);
                 // --- END IMPROVED ERROR HANDLING ---
            }
        })
        .catch(error => {
            console.error('Network or parsing error submitting form:', error);
            alert('An unexpected network error occurred. Please try again.');
        })
        .finally(() => {
             // Re-enable button and restore text
             submitButton.disabled = false;
             submitButton.textContent = 'Save Changes';
        });
    });
    // --- END FIX ---
});
</script>
{% endblock %}
